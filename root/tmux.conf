set-window-option -g mode-keys vi

# set-option -g default-command "reattach-to-user-namespace -l zsh"

unbind-key -T copy-mode-vi v
bind-key -T copy-mode-vi 'v' send-keys -X begin-selection # Begin selection in copy mode.
bind-key -T copy-mode-vi 'C-v' send-keys -X rectangle-toggle # Begin selection in copy mode.
bind-key -T copy-mode-vi 'y' send-keys -X copy-selection # Yank selection in copy mode.

set-option -g default-terminal screen-256color

# C-b is not acceptable -- Vim uses it
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Split panes with | and - (more intuitive)
unbind '"'
unbind %
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity on

# reload config
bind r source-file ~/.tmux.conf \; display-message "Config reloaded..."
bind R refresh-client

# window navigation
bind-key -n S-, prev
bind-key -n S-. next
bind C-o select-window -t 1
bind C-m select-window -t 2
bind C-e select-window -t 3
bind C-a select-window -t 4
bind C-c select-window -t 5
bind C-t select-window -t 6

# vim-tmux-navigator integration
# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'
tmux_version='$(tmux -V | sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'
if-shell -b '[ "$(echo "$tmux_version < 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\'  'select-pane -l'"
if-shell -b '[ "$(echo "$tmux_version >= 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\\\'  'select-pane -l'"

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R
bind-key -T copy-mode-vi 'C-\' select-pane -l

# Keep Alt navigation as backup
bind -n M-h select-pane -L  # Alt-h
bind -n M-j select-pane -D  # Alt-j
bind -n M-k select-pane -U  # Alt-k
bind -n M-l select-pane -R  # Alt-l

# quick view of processes
bind '~' split-window "exec htop"

# start window indexing at one instead of zero
set -g base-index 1

# Automatic window renaming to show directory/program
# When in a git repo, zsh hook sets the window name to the repo name
# Otherwise, shows command or nvim:path
set-option -g automatic-rename on
set-option -g automatic-rename-format '#{?#{==:#{pane_current_command},nvim},nvim:#{b:pane_current_path},#{?#{==:#{pane_current_command},zsh},#{b:pane_current_path},#{pane_current_command}}}'

# Window status formatting is set by tmux-theme-sync script based on Kitty theme

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity off

bind M setw monitor-activity on
bind m setw monitor-activity off

set -g status-right-length 80
set-option -g status-justify "left"

# Solarized color scheme for status bar
# Theme is synced to Kitty's current theme on startup, then toggled with Ctrl-A T

# Sync theme to match Kitty's current theme on startup
run-shell "~/.local/bin/tmux-theme-sync"

# Keybinding to toggle theme
bind-key T run-shell "~/.local/bin/tmux-theme-toggle"

# List of plugins
set -g @plugin 'tmux-plugins/tpm'  
set -g @plugin 'tmux-plugins/tmux-resurrect'  
set -g @plugin 'tmux-plugins/tmux-continuum'  
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-urlview'
set -g @plugin 'tmux-plugins/tmux-maildir-counter'
set -g @plugin 'jbnicolai/tmux-fpp'
set -g @plugin 'tmux-plugins/tmux-logging'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-copycat'
set -g @plugin 'MunifTanjim/tmux-mode-indicator'
set -g @plugin 'MunifTanjim/tmux-suspend'

set -g @suspend_key 'C-s'

# last saved environment is automatically restored when tmux is started.
set -g @continuum-restore 'on'

# set -g @maildir_counters '~/Maildir/work/INBOX/new|~/Maildir/gmail/INBOX/new|~/Maildir/gmx/INBOX/new|~/Maildir/wedding/INBOX/new|~/Maildir/rph/inbox/new'
# set -g @maildir_counter_status 'w.${maildir_counter_1} p.#{maildir_counter_2} v.#{maildir_counter_3} j.#{maildir_counter_4} y.#{maildir_counter_5}' 

bind-key W   command-prompt -p "host" "split-window 'ssh -t %1 tmux new -A -s work'"
bind-key C-w command-prompt -p "host" "new-window -n %1 'ssh -t %1 tmux new -A -s work'"

# Increase scrollback buffer
set -g history-limit 50000

# Don't wait after escape (important for Neovim)
set -sg escape-time 0


# initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '/opt/homebrew/opt/tpm/share/tpm/tpm'
